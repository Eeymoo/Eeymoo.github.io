let v=null,$=null,j=null,C=null,R=null,M=null;const E=["3mo","6mo","1y","2y","all"];let p=0,u=!1,P=!1;async function U(){if(P)return;P=!0;const f=document.getElementById("search-modal"),r=document.getElementById("modal-search-input"),w=document.getElementById("close-modal"),l=document.getElementById("search-results"),k=document.getElementById("search-empty-state"),g=document.getElementById("search-loading-state"),x=document.getElementById("regex-toggle"),m=document.getElementById("search-more"),L=document.getElementById("google-fallback");if(!f||!r||!w||!l||!k||!g||!x||!m||!L)return;const b=()=>{f.classList.add("hidden"),r.value="",I([]),k.classList.remove("hidden")};w.addEventListener("click",b),f.addEventListener("click",t=>{(t.target===f||t.target.classList.contains("backdrop-blur-sm"))&&b()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&!f.classList.contains("hidden")&&b()}),x.addEventListener("click",()=>{u=!u,u?(x.classList.add("bg-primary/10","text-primary","dark:bg-primary/20"),x.classList.remove("text-slate-500","dark:text-slate-400")):(x.classList.remove("bg-primary/10","text-primary","dark:bg-primary/20"),x.classList.add("text-slate-500","dark:text-slate-400")),r.value.trim()&&S(r.value)}),m.addEventListener("click",()=>{p<E.length-1&&(p++,r.value.trim()&&S(r.value))}),L.addEventListener("click",t=>{t.preventDefault();const e=r.value.trim();if(e){const i=window.location.hostname;window.open(`https://google.com/search?q=site:${i} ${encodeURIComponent(e)}`,"_blank")}});const A=async t=>{try{if(!v){const e=await fetch("/search/title-index.json");e.ok&&(v=await e.json())}if(t==="3mo"&&!$){const e=await fetch("/search/detail-3mo.json");e.ok&&($=await e.json())}else if(t==="6mo"&&!j){const e=await fetch("/search/detail-6mo.json");e.ok&&(j=await e.json())}else if(t==="1y"&&!C){const e=await fetch("/search/detail-1y.json");e.ok&&(C=await e.json())}else if(t==="2y"&&!R){const e=await fetch("/search/detail-2y.json");e.ok&&(R=await e.json())}else if(t==="all"&&!M){const e=await fetch("/search/detail-all.json");e.ok&&(M=await e.json())}}catch(e){console.error("Failed to load search index:",e)}},B=(t,e)=>{if(!e)return t;let i;try{u?i=new RegExp(`(${e})`,"gi"):i=new RegExp(`(${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi")}catch{return t}return t.replace(i,'<mark class="text-primary bg-transparent font-medium">$1</mark>')},H=(t,e,i=100)=>{let a=-1,o=e.length;if(u)try{const s=new RegExp(e,"gi").exec(t);s&&(a=s.index,o=s[0].length)}catch{}else{const n=t.toLowerCase(),s=e.toLowerCase();a=n.indexOf(s)}if(a===-1)return t.slice(0,i)+"...";const h=Math.max(0,a-40),y=Math.min(t.length,a+o+40);let c=t.slice(h,y);return h>0&&(c="..."+c),y<t.length&&(c=c+"..."),B(c,e)},S=async t=>{if(!t.trim()){I([]),k.classList.remove("hidden"),g.classList.add("hidden");return}if(k.classList.add("hidden"),g.classList.remove("hidden"),l.querySelectorAll(".search-result-item").forEach(n=>n.remove()),u)try{new RegExp(t,"gi")}catch{I([],t,!0),g.classList.add("hidden");return}if(await A(E[p]),!v){g.classList.add("hidden");return}const e=t.toLowerCase();let i=null;if(u)try{i=new RegExp(t,"gi")}catch{}const a=[],o=new Set,h=n=>i?(i.lastIndex=0,i.test(n)):n.toLowerCase().includes(e),y=Date.now(),c=()=>{if(Date.now()-y>1e3)throw new Error("Search timeout")};try{for(const s of v)c(),h(s.title)&&(a.push({id:s.id,type:s.type,title:s.title,uri:s.uri,hitType:"title",excerpt:s.description?B(s.description,t):"",date:s.date,score:100}),o.add(s.id));const n=[$,j,C,R,M].slice(0,p+1).filter(Boolean);for(const s of n)for(const d of s)if(c(),!o.has(d.id)&&h(d.content)){const T=v.find(N=>N.id===d.id);T&&(a.push({id:d.id,type:d.type,title:T.title,uri:T.uri,hitType:"detail",excerpt:H(d.content,t),date:d.date,score:50}),o.add(d.id))}}catch(n){if(n instanceof Error&&n.message==="Search timeout")console.warn("Search aborted due to timeout");else throw n}a.sort((n,s)=>n.score!==s.score?s.score-n.score:n.date&&s.date?new Date(s.date).getTime()-new Date(n.date).getTime():0),g.classList.add("hidden"),I(a,t)},I=(t,e="",i=!1)=>{if(l.querySelectorAll(".search-result-item").forEach(a=>a.remove()),i){const a=document.createElement("div");a.className="search-result-item py-12 text-center text-slate-500 dark:text-slate-400",a.innerHTML="<p>正则表达式语法错误</p>",l.appendChild(a),m.classList.add("hidden"),L.classList.add("hidden");return}if(t.length===0&&e.trim()){const a=document.createElement("div");a.className="search-result-item py-12 text-center text-slate-500 dark:text-slate-400",a.innerHTML="<p>未找到相关结果</p>",l.appendChild(a),m.classList.add("hidden"),L.classList.remove("hidden");return}L.classList.add("hidden"),p<E.length-1&&e.trim()?(m.classList.remove("hidden"),m.textContent=`搜索更多结果 (${E[p]} -> ${E[p+1]})`):m.classList.add("hidden"),t.forEach(a=>{const o=document.createElement("a");o.href=a.uri,o.className="search-result-item group block p-3 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors cursor-pointer border border-transparent hover:border-primary/20 no-underline";const h=a.type==="blog"?"文章":a.type==="microblog"?"微博客":a.type==="tool"?"工具":"友链",y=a.date?new Date(a.date).toISOString().split("T")[0]:"";o.innerHTML=`
        <div class="flex items-center justify-between mb-1">
          <div class="flex items-center gap-2">
            <span class="px-2 py-0.5 text-xs rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">${h}</span>
            <h3 class="text-base font-medium text-slate-900 dark:text-slate-100 group-hover:text-primary transition-colors m-0">${B(a.title,e)}</h3>
          </div>
          <span class="text-xs text-slate-500 dark:text-slate-400">${y}</span>
        </div>
        ${a.excerpt?`<p class="text-sm text-slate-600 dark:text-slate-300 line-clamp-3 mt-1 m-0">${a.excerpt}</p>`:""}
      `,l.appendChild(o)})};let D;r.addEventListener("input",t=>{clearTimeout(D);const e=t.target.value;D=setTimeout(()=>{S(e)},300)})}function F(){const r=new URLSearchParams(window.location.search).get("q");if(r){const w=document.getElementById("search-modal"),l=document.getElementById("modal-search-input");w&&l&&(w.classList.remove("hidden"),l.value=r,U().then(()=>{l.dispatchEvent(new Event("input"))}))}}export{U as initSearchCore,F as initSearchPage};

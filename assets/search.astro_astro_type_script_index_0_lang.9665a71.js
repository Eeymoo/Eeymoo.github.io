let v=null,$=null,j=null,C=null,R=null,M=null;const E=["3mo","6mo","1y","2y","all"];let f=0,g=!1,P=!1;async function U(){if(P)return;P=!0;const c=document.getElementById("search-modal"),i=document.getElementById("modal-search-input"),d=document.getElementById("close-modal"),o=document.getElementById("search-results"),k=document.getElementById("search-empty-state"),x=document.getElementById("search-loading-state"),y=document.getElementById("regex-toggle"),u=document.getElementById("search-more"),L=document.getElementById("google-fallback");if(!c||!i||!d||!o||!k||!x||!y||!u||!L)return;const B=()=>{c.classList.add("hidden"),i.value="",I([]),k.classList.remove("hidden")};d.addEventListener("click",B),c.addEventListener("click",t=>{(t.target===c||t.target.classList.contains("backdrop-blur-sm"))&&B()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&!c.classList.contains("hidden")&&B()}),y.addEventListener("click",()=>{g=!g,g?(y.classList.add("bg-primary/10","text-primary","dark:bg-primary/20"),y.classList.remove("text-slate-500","dark:text-slate-400")):(y.classList.remove("bg-primary/10","text-primary","dark:bg-primary/20"),y.classList.add("text-slate-500","dark:text-slate-400")),i.value.trim()&&S(i.value)}),u.addEventListener("click",()=>{f<E.length-1&&(f++,i.value.trim()&&S(i.value))}),L.addEventListener("click",t=>{t.preventDefault();const e=i.value.trim();if(e){const r=window.location.hostname;window.open(`https://google.com/search?q=site:${r} ${encodeURIComponent(e)}`,"_blank")}});const A=async t=>{try{if(!v){const e=await fetch("/search/title-index.json");e.ok&&(v=await e.json())}if(t==="3mo"&&!$){const e=await fetch("/search/detail-3mo.json");e.ok&&($=await e.json())}else if(t==="6mo"&&!j){const e=await fetch("/search/detail-6mo.json");e.ok&&(j=await e.json())}else if(t==="1y"&&!C){const e=await fetch("/search/detail-1y.json");e.ok&&(C=await e.json())}else if(t==="2y"&&!R){const e=await fetch("/search/detail-2y.json");e.ok&&(R=await e.json())}else if(t==="all"&&!M){const e=await fetch("/search/detail-all.json");e.ok&&(M=await e.json())}}catch(e){console.error("Failed to load search index:",e)}},b=(t,e)=>{if(!e)return t;let r;try{g?r=new RegExp(`(${e})`,"gi"):r=new RegExp(`(${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi")}catch{return t}return t.replace(r,'<mark class="text-primary bg-transparent font-medium">$1</mark>')},H=(t,e,r=100)=>{let s=-1,l=e.length;if(g)try{const a=new RegExp(e,"gi").exec(t);a&&(s=a.index,l=a[0].length)}catch{}else{const n=t.toLowerCase(),a=e.toLowerCase();s=n.indexOf(a)}if(s===-1)return t.slice(0,r)+"...";const p=Math.max(0,s-40),w=Math.min(t.length,s+l+40);let m=t.slice(p,w);return p>0&&(m="..."+m),w<t.length&&(m=m+"..."),b(m,e)},S=async t=>{if(!t.trim()){I([]),k.classList.remove("hidden"),x.classList.add("hidden");return}if(k.classList.add("hidden"),x.classList.remove("hidden"),o.querySelectorAll(".search-result-item").forEach(n=>n.remove()),g)try{new RegExp(t,"gi")}catch{I([],t,!0),x.classList.add("hidden");return}if(await A(E[f]),!v){x.classList.add("hidden");return}const e=t.toLowerCase();let r=null;if(g)try{r=new RegExp(t,"gi")}catch{}const s=[],l=new Set,p=n=>r?(r.lastIndex=0,r.test(n)):n.toLowerCase().includes(e),w=Date.now(),m=()=>{if(Date.now()-w>1e3)throw new Error("Search timeout")};try{for(const a of v)m(),p(a.title)&&(s.push({id:a.id,type:a.type,title:a.title,uri:a.uri,hitType:"title",excerpt:a.description?b(a.description,t):"",date:a.date,score:100}),l.add(a.id));const n=[$,j,C,R,M].slice(0,f+1).filter(Boolean);for(const a of n)for(const h of a)if(m(),!l.has(h.id)&&p(h.content)){const T=v.find(N=>N.id===h.id);T&&(s.push({id:h.id,type:h.type,title:T.title,uri:T.uri,hitType:"detail",excerpt:H(h.content,t),date:h.date,score:50}),l.add(h.id))}}catch(n){if(n instanceof Error&&n.message==="Search timeout")console.warn("Search aborted due to timeout");else throw n}s.sort((n,a)=>n.score!==a.score?a.score-n.score:n.date&&a.date?new Date(a.date).getTime()-new Date(n.date).getTime():0),x.classList.add("hidden"),I(s,t)},I=(t,e="",r=!1)=>{if(o.querySelectorAll(".search-result-item").forEach(s=>s.remove()),r){const s=document.createElement("div");s.className="search-result-item py-12 text-center text-slate-500 dark:text-slate-400",s.innerHTML="<p>正则表达式语法错误</p>",o.appendChild(s),u.classList.add("hidden"),L.classList.add("hidden");return}if(t.length===0&&e.trim()){const s=document.createElement("div");s.className="search-result-item py-12 text-center text-slate-500 dark:text-slate-400",s.innerHTML="<p>未找到相关结果</p>",o.appendChild(s),u.classList.add("hidden"),L.classList.remove("hidden");return}L.classList.add("hidden"),f<E.length-1&&e.trim()?(u.classList.remove("hidden"),u.textContent=`搜索更多结果 (${E[f]} -> ${E[f+1]})`):u.classList.add("hidden"),t.forEach(s=>{const l=document.createElement("a");l.href=s.uri,l.className="search-result-item group block p-3 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors cursor-pointer border border-transparent hover:border-primary/20 no-underline";const p=s.type==="blog"?"文章":s.type==="microblog"?"微博客":s.type==="tool"?"工具":"友链",w=s.date?new Date(s.date).toISOString().split("T")[0]:"";l.innerHTML=`
        <div class="flex items-center justify-between mb-1">
          <div class="flex items-center gap-2">
            <span class="px-2 py-0.5 text-xs rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">${p}</span>
            <h3 class="text-base font-medium text-slate-900 dark:text-slate-100 group-hover:text-primary transition-colors m-0">${b(s.title,e)}</h3>
          </div>
          <span class="text-xs text-slate-500 dark:text-slate-400">${w}</span>
        </div>
        ${s.excerpt?`<p class="text-sm text-slate-600 dark:text-slate-300 line-clamp-3 mt-1 m-0">${s.excerpt}</p>`:""}
      `,o.appendChild(l)})};let D;i.addEventListener("input",t=>{clearTimeout(D);const e=t.target.value;D=setTimeout(()=>{S(e)},300)})}function F(){const i=new URLSearchParams(window.location.search).get("q");if(i){const d=document.getElementById("search-modal"),o=document.getElementById("modal-search-input");d&&o&&(d.classList.remove("hidden"),o.value=i,U().then(()=>{o.dispatchEvent(new Event("input"))}))}}U().then(()=>{F();const c=document.getElementById("open-search-btn"),i=document.getElementById("search-modal"),d=document.getElementById("modal-search-input");c&&i&&d&&(c.addEventListener("click",()=>{i.classList.remove("hidden"),d.focus()}),new URLSearchParams(window.location.search).get("q")||(i.classList.remove("hidden"),d.focus()))});
